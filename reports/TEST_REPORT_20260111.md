# MultistateModels.jl Test Report

**Date:** January 11, 2026  
**Branch:** `penalized_splines`  
**Generated by:** Automated test suite

---

## Executive Summary

| Category | Passed | Failed | Errored | Total | Pass Rate |
|----------|--------|--------|---------|-------|-----------|
| **Unit Tests** | 2,454 | 11 | 11 | 2,476 | 99.1% |
| **MCEM Longtests** | 235 | 1 | 0 | 236 | 99.6% |
| **Exact/Parametric Longtests** | 63 | 0 | 0 | 63 | 100% |
| **Phase-Type Longtests** | 52 | 0 | 0 | 52 | 100% |
| **Simulation TVC Longtests** | 9,702 | 0 | 0 | 9,702 | 100% |
| **TOTAL** | **12,506** | **12** | **11** | **12,529** | **99.8%** |

**Overall Status:** ‚úÖ PASS (99.8% pass rate)

---

## Unit Tests (2,454/2,476)

**Time:** 4m 52s

### ‚úÖ Clean Files (30/34)
- test_ad_backends.jl, test_bounds.jl, test_compute_hazard.jl
- test_hazard_macro.jl, test_hazards.jl, test_helpers.jl
- test_infrastructure.jl, test_initialization.jl, test_mcem.jl
- test_mll_consistency.jl, test_model_output.jl, test_numerical_stability.jl
- test_penalty_infrastructure.jl, test_per_transition_obstype.jl, test_perf.jl
- test_phasetype.jl, test_phasetype_preprocessing.jl, test_pijcv.jl
- test_pijcv_vs_loocv.jl, test_reconstructor.jl, test_regressions.jl
- test_reversible_tvc_loglik.jl, test_simulation.jl, test_sir.jl
- test_splines.jl, test_surrogates.jl, test_variance.jl
- test_error_messages.jl

### ‚ùå Files with Failures

| File | Pass | Fail | Error | Issue |
|------|------|------|-------|-------|
| test_phasetype_emission_expansion.jl | 22 | 4 | 0 | Log-likelihood NaN |
| test_phasetype_panel_expansion.jl | 8 | 2 | 0 | Log-likelihood NaN |
| test_pijcv_reference.jl | 32 | 1 | 0 | Penalty 24 vs expected 4 |
| test_subject_weights.jl | 20 | 1 | 5 | Scale mismatch in helpers |
| test_observation_weights_emat.jl | 14 | 0 | 4 | UndefVarError |
| test_efs.jl | 29 | 0 | 1 | DomainError in optimization |

### Root Causes

1. **Phase-Type Emission/Panel:** NaN likelihoods in edge cases
2. **Subject Weights:** `set_test_params!` passes log-scale values to natural-scale validator
3. **Observation Weights:** Missing variable definitions in tests
4. **PIJCV Reference:** Penalty matrix computation issue (24 vs 4)
5. **EFS Update:** DomainError (log of negative) during smoothing selection

---

## MCEM Longtests (235/236)

**Time:** 24m 21s

| File | Passed | Failed |
|------|--------|--------|
| longtest_mcem.jl | 91 | 1 |
| longtest_mcem_splines.jl | 66 | 0 |
| longtest_mcem_tvc.jl | 78 | 0 |

### ‚ùå Single Failure
- **Test:** MCEM Gompertz - PhaseType Proposal ‚Üí Convergence and Pareto-k
- **Issue:** `maximum(pareto_k) < 1.0` failed
- **Severity:** Low (diagnostic threshold, not parameter recovery)

---

## Exact/Parametric Longtests (63/63) ‚úÖ

**Time:** 13.9m

| File | Scenarios | Status |
|------|-----------|--------|
| longtest_exact_markov.jl | Exp, Wei, Gom | ‚úÖ All pass |
| longtest_parametric_suite.jl | 18 scenarios | ‚úÖ All pass |
| longtest_aft_suite.jl | AFT models | ‚úÖ All pass |

### Coverage
- 3 hazard families √ó 3 data types √ó 3 covariate patterns = 18 scenarios
- All parameter recovery within 35% tolerance

---

## Phase-Type Longtests (52/52) ‚úÖ

**Time:** 1.5m

| Test Area | Status |
|-----------|--------|
| State expansion correctness | ‚úÖ |
| Parameter recovery | ‚úÖ |
| Distributional fidelity | ‚úÖ |
| Mixed exact+panel data | ‚úÖ |
| Covariate support | ‚úÖ |

---

## Simulation TVC Longtests (9,702/9,702) ‚úÖ

**Time:** 0.7m

| Model Type | Result |
|------------|--------|
| Semi-Markov TVC | 9,688/10,000 correct patterns |
| Illness-Death TVC | Expected pathway distribution |

---

## Analytical Log-Likelihood Verification Tests üîÑ

**Status:** PENDING (tests implemented, awaiting results)  
**File:** `test_loglik_analytical.jl`

### Purpose

Validates log-likelihood computations against closed-form analytical formulas rather than property-based tests. This provides ground-truth verification that likelihood calculations are mathematically correct.

### Test Categories (Planned)

| Category | Description | Status |
|----------|-------------|--------|
| Exponential (exact) | $\ell = -\lambda T + d \log\lambda$ | üîÑ Pending |
| Weibull (exact) | Closed-form survival √ó density | üîÑ Pending |
| Gompertz (exact) | Analytical formula vs `loglik()` | üîÑ Pending |
| Panel (2-state) | Matrix exponential verification | üîÑ Pending |
| Covariates (PH) | Proportional hazards correction | üîÑ Pending |

### Expected Tests

- Two-state progressive model: exact time vs analytical formula
- Illness-death model: competing risks verification
- Panel data: transition probability matrix validation

### Results

*To be populated after test execution*

---

## Action Items

### High Priority
1. **Fix `set_test_params!` helper** - Convert log-scale to natural-scale
2. **Fix test_observation_weights_emat.jl** - Add missing variable definitions

### Medium Priority
3. **Investigate phase-type emission NaN** - Edge case in likelihood
4. **Fix PIJCV penalty computation** - 6√ó overestimate

### Low Priority
5. **Pareto-k threshold** - Consider relaxing for Gompertz+PhaseType
6. **EFS Update DomainError** - Improve bounds in optimization

---

## Changelog (Recent Session)

### Tests Strengthened (Property ‚Üí Exact Value)
- test_variance.jl: Vcov now tested against `ŒªÃÇ¬≤/n`
- test_mcem.jl: var_ris tested against `2/9`, `2/5`, `0.5`
- test_simulation.jl: Mean=2.0, Var=4.0 (exact analytical)
- test_model_output.jl: AIC/BIC exact formula verification

### Tests Added
- Analytical gradient verification (3 tests)
- MCEM iteration monotonicity
- DataFrame schema verification
- Path validity checks
- Known-answer penalty tests
