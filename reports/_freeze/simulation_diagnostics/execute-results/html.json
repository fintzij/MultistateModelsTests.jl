{
  "hash": "76cb0ca68d0b9644924f7e51d9150003",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"Simulation Diagnostics\"\nsubtitle: \"Verifying Simulated Distributions Match Theoretical Formulas\"\nformat:\n  html:\n    toc: true\n    toc-depth: 3\n    toc-expand: 2\n    code-fold: true\n    code-summary: \"Show code\"\nexecute:\n  echo: true\n  warning: false\n  freeze: auto\n---\n\n\n\n## Overview\n\nThis report validates that MultistateModels.jl correctly simulates event times by comparing:\n\n1. **Empirical CDFs** of simulated event times against theoretical CDFs\n2. **Hazard functions** computed by the package against analytical formulas\n3. **Cumulative hazard functions** computed vs. expected\n\nFor each hazard family (Exponential, Weibull, Gompertz) and covariate effect type (PH, AFT), we:\n- Simulate many event times from a 2-state model\n- Compare the empirical distribution to the theoretical distribution\n- Report the maximum absolute difference in CDF (should be ≈ 0)\n\n## Configuration\n\n::: {#4353a2e6 .cell execution_count=2}\n``` {.julia .cell-code}\nconst COVARIATE_VALUE = 1.5\nconst SIM_SAMPLES = 40_000\nconst DIST_GRID_POINTS = 400\n\n# Horizons must be large enough to ensure negligible right-truncation (<0.1%)\n# For Exponential with AFT covariates: effective rate = 0.35 * exp(-0.6*1.5) ≈ 0.14\n# Need: exp(-rate * horizon) < 0.001 => horizon > log(1000)/rate ≈ 50\n# Setting horizon = 100 provides ample margin\nconst FAMILY_CONFIG = Dict(\n    \"exp\" => (; rate = 0.35, beta = 0.6, horizon = 100.0),\n    \"wei\" => (; shape = 1.35, scale = 0.4, beta = -0.35, horizon = 50.0),\n    \"gom\" => (; shape = 0.6, rate = 0.4, beta = 0.5, horizon = 10.0),  # Gompertz diverges quickly\n)\n```\n\n::: {.cell-output .cell-output-display execution_count=5}\n```\nDict{String, NamedTuple} with 3 entries:\n  \"exp\" => (rate = 0.35, beta = 0.6, horizon = 100.0)\n  \"wei\" => (shape = 1.35, scale = 0.4, beta = -0.35, horizon = 50.0)\n  \"gom\" => (shape = 0.6, rate = 0.4, beta = 0.5, horizon = 10.0)\n```\n:::\n:::\n\n\n## Analytical Reference Formulas\n\n### Exponential Distribution\n- **Hazard**: $h(t) = \\lambda$\n- **Cumulative hazard**: $H(t) = \\lambda t$\n- **CDF**: $F(t) = 1 - e^{-\\lambda t}$\n\n### Weibull Distribution (shape $\\kappa$, scale $\\lambda$)\n- **Hazard**: $h(t) = \\kappa \\lambda t^{\\kappa-1}$\n- **Cumulative hazard**: $H(t) = \\lambda t^\\kappa$\n- **CDF**: $F(t) = 1 - e^{-\\lambda t^\\kappa}$\n\n### Gompertz Distribution (flexsurv parameterization: shape $a$, rate $b$)\n- **Hazard**: $h(t) = b e^{at}$\n- **Cumulative hazard**: $H(t) = \\frac{b}{a}(e^{at} - 1)$\n- **CDF**: $F(t) = 1 - e^{-H(t)}$\n\n### Covariate Effects\n\n**Proportional Hazards (PH)**: $h(t|x) = h_0(t) e^{\\beta x}$\n\n**Accelerated Failure Time (AFT)**: $h(t|x) = h_0(t \\cdot e^{-\\beta x}) \\cdot e^{-\\beta x}$\n\n## Helper Functions\n\n::: {#f7655420 .cell execution_count=3}\n``` {.julia .cell-code code-fold=\"true\"}\n# Create a 2-state model for a given scenario\nfunction build_test_model(family::String, effect::Symbol, with_covariate::Bool)\n    cfg = FAMILY_CONFIG[family]\n    \n    # Build data frame\n    if with_covariate\n        data = DataFrame(\n            id = [1], tstart = [0.0], tstop = [cfg.horizon],\n            statefrom = [1], stateto = [2], obstype = [1],\n            x = [COVARIATE_VALUE]\n        )\n        formula = @formula(0 ~ x)\n    else\n        data = DataFrame(\n            id = [1], tstart = [0.0], tstop = [cfg.horizon],\n            statefrom = [1], stateto = [2], obstype = [1]\n        )\n        formula = @formula(0 ~ 1)\n    end\n    \n    # Build hazard\n    hazard = Hazard(formula, family, 1, 2; linpred_effect = effect)\n    model = multistatemodel(hazard; data = data)\n    \n    # Set parameters\n    if family == \"exp\"\n        base = [log(cfg.rate)]\n    elseif family == \"wei\"\n        base = [log(cfg.shape), log(cfg.scale)]\n    elseif family == \"gom\"\n        base = [cfg.shape, log(cfg.rate)]  # shape unconstrained, rate log-transformed\n    end\n    \n    pars = with_covariate ? vcat(base, [cfg.beta]) : base\n    hazname = model.hazards[1].hazname\n    set_parameters!(model, NamedTuple{(hazname,)}((pars,)))\n    \n    return model, cfg\nend\n\n# Compute expected CDF for given scenario\nfunction expected_cdf(family::String, effect::Symbol, with_covariate::Bool, t::Float64)\n    cfg = FAMILY_CONFIG[family]\n    xval = with_covariate ? COVARIATE_VALUE : 0.0\n    beta = with_covariate ? cfg.beta : 0.0\n    \n    cumhaz = if family == \"exp\"\n        rate = effect == :ph ? cfg.rate * exp(beta * xval) : cfg.rate * exp(-beta * xval)\n        rate * t\n    elseif family == \"wei\"\n        shape, scale = cfg.shape, cfg.scale\n        mult = effect == :ph ? exp(beta * xval) : exp(-shape * beta * xval)\n        scale * mult * (t^shape)\n    elseif family == \"gom\"\n        shape, rate = cfg.shape, cfg.rate\n        linpred = beta * xval\n        if effect == :ph\n            (rate / shape) * exp(linpred) * (exp(shape * t) - 1)\n        else\n            time_scale = exp(-linpred)\n            scaled_shape = shape * time_scale\n            scaled_rate = rate * time_scale\n            (scaled_rate / scaled_shape) * (exp(scaled_shape * t) - 1)\n        end\n    end\n    \n    return 1 - exp(-cumhaz)\nend\n\n# Simulate event times from model\n# WARNING: Only collects paths where a transition occurred within horizon.\n# Set horizon large enough so P(T > horizon) < 0.001 to avoid right-truncation bias.\nfunction simulate_event_times(model, nsim::Int; rng = Random.default_rng())\n    durations = Float64[]\n    n_censored = 0\n    strategy = CachedTransformStrategy()\n    total_attempts = 0\n    max_attempts = nsim * 20  # Safety limit\n    \n    while length(durations) < nsim && total_attempts < max_attempts\n        total_attempts += 1\n        path = simulate_path(model, 1; strategy = strategy, rng = rng)\n        if path.states[end] != path.states[1]\n            push!(durations, path.times[end] - path.times[1])\n        else\n            n_censored += 1\n        end\n    end\n    \n    # Warn if significant truncation detected\n    truncation_rate = n_censored / total_attempts\n    if truncation_rate > 0.01\n        @warn \"High right-truncation rate: $(round(truncation_rate*100, digits=1))%. Increase horizon.\"\n    end\n    \n    return durations\nend\n\n# Compute maximum CDF difference\nfunction max_cdf_diff(durations::Vector{Float64}, cdf_func, horizon::Float64)\n    # Compute empirical CDF\n    sorted = sort(durations)\n    n = length(sorted)\n    ecdf_vals = (1:n) ./ n\n    \n    # Compute theoretical CDF at each point\n    tcdf_vals = [cdf_func(t) for t in sorted]\n    \n    # Max absolute difference\n    return maximum(abs.(ecdf_vals .- tcdf_vals))\nend\n```\n\n::: {.cell-output .cell-output-display execution_count=6}\n```\nmax_cdf_diff (generic function with 1 method)\n```\n:::\n:::\n\n\n## Diagnostic Results\n\n::: {#tbl-results .cell tbl-cap='Simulation Diagnostic Summary' execution_count=4}\n``` {.julia .cell-code}\n# Run diagnostics for all scenarios\nresults = DataFrame(\n    Family = String[],\n    Effect = String[],\n    Covariate = String[],\n    MaxCDFDiff = Float64[],\n    Status = String[]\n)\n\nscenarios = [\n    (\"exp\", :ph, false), (\"exp\", :ph, true),\n    (\"exp\", :aft, false), (\"exp\", :aft, true),\n    (\"wei\", :ph, false), (\"wei\", :ph, true),\n    (\"wei\", :aft, false), (\"wei\", :aft, true),\n    (\"gom\", :ph, false), (\"gom\", :ph, true),\n    (\"gom\", :aft, false), (\"gom\", :aft, true),\n]\n\nRandom.seed!(12345)\n\nfor (family, effect, with_cov) in scenarios\n    model, cfg = build_test_model(family, effect, with_cov)\n    \n    # Simulate event times\n    durations = simulate_event_times(model, SIM_SAMPLES)\n    \n    # Expected CDF function\n    cdf_func = t -> expected_cdf(family, effect, with_cov, t)\n    \n    # Compute max difference\n    max_diff = max_cdf_diff(durations, cdf_func, cfg.horizon)\n    \n    push!(results, (\n        uppercasefirst(family),\n        uppercase(String(effect)),\n        with_cov ? \"Yes\" : \"No\",\n        round(max_diff, digits=4),\n        max_diff < 0.02 ? \"✅ Pass\" : \"❌ Fail\"\n    ))\nend\n\nresults\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n******************************************************************************\nThis program contains Ipopt, a library for large-scale nonlinear optimization.\n Ipopt is released as open source code under the Eclipse Public License (EPL).\n         For more information visit https://github.com/coin-or/Ipopt\n******************************************************************************\n\n```\n:::\n\n::: {.cell-output .cell-output-display execution_count=7}\n```{=html}\n<div><div style = \"float: left;\"><span>12×5 DataFrame</span></div><div style = \"clear: both;\"></div></div><div class = \"data-frame\" style = \"overflow-x: scroll;\"><table class = \"data-frame\" style = \"margin-bottom: 6px;\"><thead><tr class = \"header\"><th class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">Row</th><th style = \"text-align: left;\">Family</th><th style = \"text-align: left;\">Effect</th><th style = \"text-align: left;\">Covariate</th><th style = \"text-align: left;\">MaxCDFDiff</th><th style = \"text-align: left;\">Status</th></tr><tr class = \"subheader headerLastRow\"><th class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\"></th><th title = \"String\" style = \"text-align: left;\">String</th><th title = \"String\" style = \"text-align: left;\">String</th><th title = \"String\" style = \"text-align: left;\">String</th><th title = \"Float64\" style = \"text-align: left;\">Float64</th><th title = \"String\" style = \"text-align: left;\">String</th></tr></thead><tbody><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">1</td><td style = \"text-align: left;\">Exp</td><td style = \"text-align: left;\">PH</td><td style = \"text-align: left;\">No</td><td style = \"text-align: right;\">0.0042</td><td style = \"text-align: left;\">✅ Pass</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">2</td><td style = \"text-align: left;\">Exp</td><td style = \"text-align: left;\">PH</td><td style = \"text-align: left;\">Yes</td><td style = \"text-align: right;\">0.0034</td><td style = \"text-align: left;\">✅ Pass</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">3</td><td style = \"text-align: left;\">Exp</td><td style = \"text-align: left;\">AFT</td><td style = \"text-align: left;\">No</td><td style = \"text-align: right;\">0.0039</td><td style = \"text-align: left;\">✅ Pass</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">4</td><td style = \"text-align: left;\">Exp</td><td style = \"text-align: left;\">AFT</td><td style = \"text-align: left;\">Yes</td><td style = \"text-align: right;\">0.0042</td><td style = \"text-align: left;\">✅ Pass</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">5</td><td style = \"text-align: left;\">Wei</td><td style = \"text-align: left;\">PH</td><td style = \"text-align: left;\">No</td><td style = \"text-align: right;\">0.0063</td><td style = \"text-align: left;\">✅ Pass</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">6</td><td style = \"text-align: left;\">Wei</td><td style = \"text-align: left;\">PH</td><td style = \"text-align: left;\">Yes</td><td style = \"text-align: right;\">0.0035</td><td style = \"text-align: left;\">✅ Pass</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">7</td><td style = \"text-align: left;\">Wei</td><td style = \"text-align: left;\">AFT</td><td style = \"text-align: left;\">No</td><td style = \"text-align: right;\">0.0063</td><td style = \"text-align: left;\">✅ Pass</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">8</td><td style = \"text-align: left;\">Wei</td><td style = \"text-align: left;\">AFT</td><td style = \"text-align: left;\">Yes</td><td style = \"text-align: right;\">0.0031</td><td style = \"text-align: left;\">✅ Pass</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">9</td><td style = \"text-align: left;\">Gom</td><td style = \"text-align: left;\">PH</td><td style = \"text-align: left;\">No</td><td style = \"text-align: right;\">0.0088</td><td style = \"text-align: left;\">✅ Pass</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">10</td><td style = \"text-align: left;\">Gom</td><td style = \"text-align: left;\">PH</td><td style = \"text-align: left;\">Yes</td><td style = \"text-align: right;\">0.0045</td><td style = \"text-align: left;\">✅ Pass</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">11</td><td style = \"text-align: left;\">Gom</td><td style = \"text-align: left;\">AFT</td><td style = \"text-align: left;\">No</td><td style = \"text-align: right;\">0.0054</td><td style = \"text-align: left;\">✅ Pass</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">12</td><td style = \"text-align: left;\">Gom</td><td style = \"text-align: left;\">AFT</td><td style = \"text-align: left;\">Yes</td><td style = \"text-align: right;\">0.0046</td><td style = \"text-align: left;\">✅ Pass</td></tr></tbody></table></div>\n```\n:::\n:::\n\n\n## Diagnostic Plots\n\n### Exponential Distribution\n\n::: {#cell-fig-exp .cell fig-height='8' execution_count=5}\n``` {.julia .cell-code}\nfig = Figure(size=(900, 700))\n\nRandom.seed!(11111)\n\n# Baseline PH\nmodel_exp_base, cfg_exp = build_test_model(\"exp\", :ph, false)\ndurations_exp_base = simulate_event_times(model_exp_base, SIM_SAMPLES)\n\nax1 = Axis(fig[1, 1], xlabel=\"Time\", ylabel=\"CDF\", title=\"Exp PH Baseline\")\nt_grid = range(0, cfg_exp.horizon, length=DIST_GRID_POINTS)\necdf_exp = ecdf(durations_exp_base)\nlines!(ax1, t_grid, [ecdf_exp(t) for t in t_grid], label=\"Empirical\", linewidth=2)\nlines!(ax1, t_grid, [expected_cdf(\"exp\", :ph, false, t) for t in t_grid], \n       label=\"Theoretical\", linestyle=:dash, linewidth=2, color=:red)\naxislegend(ax1, position=:rb)\n\n# With covariate PH\nmodel_exp_cov, _ = build_test_model(\"exp\", :ph, true)\ndurations_exp_cov = simulate_event_times(model_exp_cov, SIM_SAMPLES)\n\nax2 = Axis(fig[1, 2], xlabel=\"Time\", ylabel=\"CDF\", title=\"Exp PH with Covariate\")\necdf_exp_cov = ecdf(durations_exp_cov)\nlines!(ax2, t_grid, [ecdf_exp_cov(t) for t in t_grid], label=\"Empirical\", linewidth=2)\nlines!(ax2, t_grid, [expected_cdf(\"exp\", :ph, true, t) for t in t_grid], \n       label=\"Theoretical\", linestyle=:dash, linewidth=2, color=:red)\naxislegend(ax2, position=:rb)\n\n# AFT baseline\nmodel_exp_aft, _ = build_test_model(\"exp\", :aft, false)\ndurations_exp_aft = simulate_event_times(model_exp_aft, SIM_SAMPLES)\n\nax3 = Axis(fig[2, 1], xlabel=\"Time\", ylabel=\"CDF\", title=\"Exp AFT Baseline\")\necdf_exp_aft = ecdf(durations_exp_aft)\nlines!(ax3, t_grid, [ecdf_exp_aft(t) for t in t_grid], label=\"Empirical\", linewidth=2)\nlines!(ax3, t_grid, [expected_cdf(\"exp\", :aft, false, t) for t in t_grid], \n       label=\"Theoretical\", linestyle=:dash, linewidth=2, color=:red)\naxislegend(ax3, position=:rb)\n\n# AFT with covariate\nmodel_exp_aft_cov, _ = build_test_model(\"exp\", :aft, true)\ndurations_exp_aft_cov = simulate_event_times(model_exp_aft_cov, SIM_SAMPLES)\n\nax4 = Axis(fig[2, 2], xlabel=\"Time\", ylabel=\"CDF\", title=\"Exp AFT with Covariate\")\necdf_exp_aft_cov = ecdf(durations_exp_aft_cov)\nlines!(ax4, t_grid, [ecdf_exp_aft_cov(t) for t in t_grid], label=\"Empirical\", linewidth=2)\nlines!(ax4, t_grid, [expected_cdf(\"exp\", :aft, true, t) for t in t_grid], \n       label=\"Theoretical\", linestyle=:dash, linewidth=2, color=:red)\naxislegend(ax4, position=:rb)\n\nfig\n```\n\n::: {.cell-output .cell-output-display execution_count=8}\n![Exponential Hazard Diagnostics](simulation_diagnostics_files/figure-html/fig-exp-output-1.svg){#fig-exp}\n:::\n:::\n\n\n### Weibull Distribution\n\n::: {#cell-fig-wei .cell fig-height='8' execution_count=6}\n``` {.julia .cell-code}\nfig = Figure(size=(900, 700))\n\nRandom.seed!(22222)\ncfg_wei = FAMILY_CONFIG[\"wei\"]\nt_grid_wei = range(0.02, cfg_wei.horizon, length=DIST_GRID_POINTS)  # Start > 0 for Weibull\n\n# Baseline PH\nmodel_wei_base, _ = build_test_model(\"wei\", :ph, false)\ndurations_wei_base = simulate_event_times(model_wei_base, SIM_SAMPLES)\n\nax1 = Axis(fig[1, 1], xlabel=\"Time\", ylabel=\"CDF\", title=\"Weibull PH Baseline\")\necdf_wei = ecdf(durations_wei_base)\nlines!(ax1, t_grid_wei, [ecdf_wei(t) for t in t_grid_wei], label=\"Empirical\", linewidth=2)\nlines!(ax1, t_grid_wei, [expected_cdf(\"wei\", :ph, false, t) for t in t_grid_wei], \n       label=\"Theoretical\", linestyle=:dash, linewidth=2, color=:red)\naxislegend(ax1, position=:rb)\n\n# With covariate PH\nmodel_wei_cov, _ = build_test_model(\"wei\", :ph, true)\ndurations_wei_cov = simulate_event_times(model_wei_cov, SIM_SAMPLES)\n\nax2 = Axis(fig[1, 2], xlabel=\"Time\", ylabel=\"CDF\", title=\"Weibull PH with Covariate\")\necdf_wei_cov = ecdf(durations_wei_cov)\nlines!(ax2, t_grid_wei, [ecdf_wei_cov(t) for t in t_grid_wei], label=\"Empirical\", linewidth=2)\nlines!(ax2, t_grid_wei, [expected_cdf(\"wei\", :ph, true, t) for t in t_grid_wei], \n       label=\"Theoretical\", linestyle=:dash, linewidth=2, color=:red)\naxislegend(ax2, position=:rb)\n\n# AFT baseline\nmodel_wei_aft, _ = build_test_model(\"wei\", :aft, false)\ndurations_wei_aft = simulate_event_times(model_wei_aft, SIM_SAMPLES)\n\nax3 = Axis(fig[2, 1], xlabel=\"Time\", ylabel=\"CDF\", title=\"Weibull AFT Baseline\")\necdf_wei_aft = ecdf(durations_wei_aft)\nlines!(ax3, t_grid_wei, [ecdf_wei_aft(t) for t in t_grid_wei], label=\"Empirical\", linewidth=2)\nlines!(ax3, t_grid_wei, [expected_cdf(\"wei\", :aft, false, t) for t in t_grid_wei], \n       label=\"Theoretical\", linestyle=:dash, linewidth=2, color=:red)\naxislegend(ax3, position=:rb)\n\n# AFT with covariate\nmodel_wei_aft_cov, _ = build_test_model(\"wei\", :aft, true)\ndurations_wei_aft_cov = simulate_event_times(model_wei_aft_cov, SIM_SAMPLES)\n\nax4 = Axis(fig[2, 2], xlabel=\"Time\", ylabel=\"CDF\", title=\"Weibull AFT with Covariate\")\necdf_wei_aft_cov = ecdf(durations_wei_aft_cov)\nlines!(ax4, t_grid_wei, [ecdf_wei_aft_cov(t) for t in t_grid_wei], label=\"Empirical\", linewidth=2)\nlines!(ax4, t_grid_wei, [expected_cdf(\"wei\", :aft, true, t) for t in t_grid_wei], \n       label=\"Theoretical\", linestyle=:dash, linewidth=2, color=:red)\naxislegend(ax4, position=:rb)\n\nfig\n```\n\n::: {.cell-output .cell-output-display execution_count=9}\n![Weibull Hazard Diagnostics](simulation_diagnostics_files/figure-html/fig-wei-output-1.svg){#fig-wei}\n:::\n:::\n\n\n### Gompertz Distribution\n\n::: {#cell-fig-gom .cell fig-height='8' execution_count=7}\n``` {.julia .cell-code}\nfig = Figure(size=(900, 700))\n\nRandom.seed!(33333)\ncfg_gom = FAMILY_CONFIG[\"gom\"]\nt_grid_gom = range(0, cfg_gom.horizon, length=DIST_GRID_POINTS)\n\n# Baseline PH\nmodel_gom_base, _ = build_test_model(\"gom\", :ph, false)\ndurations_gom_base = simulate_event_times(model_gom_base, SIM_SAMPLES)\n\nax1 = Axis(fig[1, 1], xlabel=\"Time\", ylabel=\"CDF\", title=\"Gompertz PH Baseline\")\necdf_gom = ecdf(durations_gom_base)\nlines!(ax1, t_grid_gom, [ecdf_gom(t) for t in t_grid_gom], label=\"Empirical\", linewidth=2)\nlines!(ax1, t_grid_gom, [expected_cdf(\"gom\", :ph, false, t) for t in t_grid_gom], \n       label=\"Theoretical\", linestyle=:dash, linewidth=2, color=:red)\naxislegend(ax1, position=:rb)\n\n# With covariate PH\nmodel_gom_cov, _ = build_test_model(\"gom\", :ph, true)\ndurations_gom_cov = simulate_event_times(model_gom_cov, SIM_SAMPLES)\n\nax2 = Axis(fig[1, 2], xlabel=\"Time\", ylabel=\"CDF\", title=\"Gompertz PH with Covariate\")\necdf_gom_cov = ecdf(durations_gom_cov)\nlines!(ax2, t_grid_gom, [ecdf_gom_cov(t) for t in t_grid_gom], label=\"Empirical\", linewidth=2)\nlines!(ax2, t_grid_gom, [expected_cdf(\"gom\", :ph, true, t) for t in t_grid_gom], \n       label=\"Theoretical\", linestyle=:dash, linewidth=2, color=:red)\naxislegend(ax2, position=:rb)\n\n# AFT baseline\nmodel_gom_aft, _ = build_test_model(\"gom\", :aft, false)\ndurations_gom_aft = simulate_event_times(model_gom_aft, SIM_SAMPLES)\n\nax3 = Axis(fig[2, 1], xlabel=\"Time\", ylabel=\"CDF\", title=\"Gompertz AFT Baseline\")\necdf_gom_aft = ecdf(durations_gom_aft)\nlines!(ax3, t_grid_gom, [ecdf_gom_aft(t) for t in t_grid_gom], label=\"Empirical\", linewidth=2)\nlines!(ax3, t_grid_gom, [expected_cdf(\"gom\", :aft, false, t) for t in t_grid_gom], \n       label=\"Theoretical\", linestyle=:dash, linewidth=2, color=:red)\naxislegend(ax3, position=:rb)\n\n# AFT with covariate\nmodel_gom_aft_cov, _ = build_test_model(\"gom\", :aft, true)\ndurations_gom_aft_cov = simulate_event_times(model_gom_aft_cov, SIM_SAMPLES)\n\nax4 = Axis(fig[2, 2], xlabel=\"Time\", ylabel=\"CDF\", title=\"Gompertz AFT with Covariate\")\necdf_gom_aft_cov = ecdf(durations_gom_aft_cov)\nlines!(ax4, t_grid_gom, [ecdf_gom_aft_cov(t) for t in t_grid_gom], label=\"Empirical\", linewidth=2)\nlines!(ax4, t_grid_gom, [expected_cdf(\"gom\", :aft, true, t) for t in t_grid_gom], \n       label=\"Theoretical\", linestyle=:dash, linewidth=2, color=:red)\naxislegend(ax4, position=:rb)\n\nfig\n```\n\n::: {.cell-output .cell-output-display execution_count=10}\n![Gompertz Hazard Diagnostics](simulation_diagnostics_files/figure-html/fig-gom-output-1.svg){#fig-gom}\n:::\n:::\n\n\n## Hazard Function Verification\n\nThe CDF plots above implicitly verify hazard function correctness - if the hazard functions were wrong, the simulated CDFs would not match the theoretical CDFs.\n\nFor explicit verification, the hazard functions use the following formulas:\n\n| Family | Hazard $h(t)$ | Implementation |\n|--------|---------------|----------------|\n| Exponential | $\\lambda$ | `rate` |\n| Weibull | $a \\cdot b \\cdot t^{a-1}$ | `shape * scale * t^(shape-1)` |\n| Gompertz | $b \\cdot e^{at}$ | `rate * exp(shape * t)` |\n\nWhere `shape` and `scale` (or `rate`) are the distribution parameters. The Gompertz uses the flexsurv parameterization.\n\n## Summary\n\nAll simulation diagnostics pass:\n\n- **Exponential**: PH and AFT baseline and with covariates ✅\n- **Weibull**: PH and AFT baseline and with covariates ✅\n- **Gompertz**: PH and AFT baseline and with covariates ✅\n\nThe maximum CDF differences are all essentially zero (within Monte Carlo error), confirming that:\n\n1. Event time simulation is statistically correct\n2. Hazard functions are implemented correctly\n3. Covariate effects (PH and AFT) work as expected\n4. The flexsurv Gompertz parameterization is correctly implemented\n\n## Technical Notes\n\n### Gompertz Parameterization\n\nMultistateModels.jl uses the **flexsurv** Gompertz parameterization:\n- `shape` ($a$): Rate of hazard increase (can be negative for decreasing hazard)\n- `rate` ($b$): Initial hazard at $t=0$\n\nThis differs from some other parameterizations. The hazard is:\n$$h(t) = b \\cdot e^{at}$$\n\n### Simulation Strategy\n\nThe diagnostics use `CachedTransformStrategy()` which caches inverse CDF computations for efficiency. The `DirectTransformStrategy()` computes inversions fresh each time. Both should produce identical results.\n\n### Monte Carlo Error\n\nWith 40,000 samples, the expected maximum CDF error from Monte Carlo is approximately:\n$$\\sqrt{\\frac{\\log(n)}{2n}} \\approx 0.007$$\n\nSo maximum differences < 0.02 are consistent with simulation being correct.\n\n",
    "supporting": [
      "simulation_diagnostics_files"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js\" integrity=\"sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js\" integrity=\"sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}