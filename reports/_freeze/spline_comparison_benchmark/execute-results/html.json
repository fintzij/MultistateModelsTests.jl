{
  "hash": "2d425cf0a062de591e43e0320c99e272",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Spline Methods Comparison\"\nsubtitle: \"Comparing MultistateModels.jl Splines vs pammtools/mgcv and flexsurv\"\ndate: last-modified\nformat:\n  html:\n    toc: true\n    toc-depth: 3\n    code-fold: true\n    fig-width: 10\n    fig-height: 6\nexecute:\n  warning: false\n  message: false\n  freeze: auto\nengine: knitr\n---\n\n\n\n# Introduction\n\nThis report presents a comprehensive benchmark comparing three approaches for fitting \nflexible hazard models to multistate survival data:\n\n1. **MultistateModels.jl** (Julia): Joint likelihood estimation with natural cubic splines\n2. **pammtools/mgcv** (R): Piecewise-exponential additive models via GAM\n3. **flexsurv** (R): Flexible parametric survival models with spline hazards\n\nAll methods are evaluated on the same simulated dataset generated using MultistateModels.jl.\n\n# Model Specification\n\n## Illness-Death Model\n\nWe consider a three-state illness-death model without recovery:\n\n- **State 1**: Healthy (initial state)\n- **State 2**: Illness (transient state)\n- **State 3**: Death (absorbing state)\n\n**Transitions:**\n\n- $1 \\to 2$: Healthy to Illness (incidence)\n- $1 \\to 3$: Healthy to Death (direct mortality)\n- $2 \\to 3$: Illness to Death (disease-related mortality)\n\n## True Hazard Functions\n\nThe data are simulated using Weibull hazard functions with the **rate parameterization**:\n\n$$h_{rs}(t) = \\kappa_{rs} \\cdot \\lambda_{rs} \\cdot t^{\\kappa_{rs} - 1}$$\n\nwhere $\\kappa_{rs} > 0$ is the shape parameter and $\\lambda_{rs} > 0$ is the rate parameter.\n\nThe cumulative hazard is:\n$$H_{rs}(t) = \\lambda_{rs} \\cdot t^{\\kappa_{rs}}$$\n\n**True Parameter Values:**\n\n| Transition | Shape ($\\kappa$) | Rate ($\\lambda$) | Interpretation |\n|------------|------------------|------------------|----------------|\n| $h_{12}$ (Healthy to Illness) | 1.3 | 0.04 | Increasing hazard |\n| $h_{13}$ (Healthy to Death) | 1.2 | 0.015 | Mildly increasing |\n| $h_{23}$ (Illness to Death) | 1.4 | 0.08 | Higher mortality after illness |\n\n## Transition Probability Matrix\n\nFor a time-homogeneous Markov model, the transition probability matrix $\\mathbf{P}(s, t)$ \nsatisfies the Kolmogorov forward equation:\n\n$$\\frac{\\partial}{\\partial t}\\mathbf{P}(s,t) = \\mathbf{P}(s,t) \\cdot \\mathbf{Q}(t)$$\n\nwhere $\\mathbf{Q}(t)$ is the transition intensity (generator) matrix:\n\n$$\\mathbf{Q}(t) = \\begin{pmatrix}\n-(h_{12}(t) + h_{13}(t)) & h_{12}(t) & h_{13}(t) \\\\\n0 & -h_{23}(t) & h_{23}(t) \\\\\n0 & 0 & 0\n\\end{pmatrix}$$\n\nThe solution is computed via the **product integral**:\n$$\\mathbf{P}(0, t) = \\prod_{s=0}^{t} \\exp\\left(\\mathbf{Q}(s) ds\\right)$$\n\n## State Prevalence\n\nState prevalence at time $t$ for subjects starting in state 1:\n\n- $P_1(t) = P_{11}(0, t)$ - Probability of remaining healthy\n- $P_2(t) = P_{12}(0, t)$ - Probability of being in illness state\n- $P_3(t) = P_{13}(0, t)$ - Probability of having died\n\n## Cumulative Incidence Functions\n\nThe cause-specific cumulative incidence function for transition $1 \\to r$ is:\n\n$$F_{1r}(t) = \\int_0^t P_{11}(0, s) \\cdot h_{1r}(s) \\, ds$$\n\nThis represents the probability of experiencing transition $1 \\to r$ by time $t$.\n\n# Data\n\n## Loading Simulated Data\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load data generated by MultistateModels.jl\ndata_path <- \"../fixtures/illness_death_data.csv\"\nmeta_path <- \"../fixtures/illness_death_metadata.json\"\n\ndat <- read.csv(data_path)\nmeta <- fromJSON(meta_path)\n\n# Display metadata\ncat(\"Sample Size:\", meta$n_subjects, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSample Size: 1000 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Maximum Follow-up Time:\", meta$max_time, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nMaximum Follow-up Time: 20 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"\\nTrue Parameters:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nTrue Parameters:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  h12: shape =\", meta$true_params$h12$shape, \", rate =\", meta$true_params$h12$rate, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  h12: shape = 1.3 , rate = 0.04 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  h13: shape =\", meta$true_params$h13$shape, \", rate =\", meta$true_params$h13$rate, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  h13: shape = 1.2 , rate = 0.015 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  h23: shape =\", meta$true_params$h23$shape, \", rate =\", meta$true_params$h23$rate, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  h23: shape = 1.4 , rate = 0.08 \n```\n\n\n:::\n:::\n\n\n## Data Summary\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Transition counts\ntrans_counts <- dat %>%\n  filter(status == 1) %>%\n  count(from, to) %>%\n  mutate(transition = paste0(from, \" -> \", to))\n\nkable(trans_counts, caption = \"Observed Transition Counts\") %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"margin-left: auto; margin-right: auto;\">\n<caption>Observed Transition Counts</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> from </th>\n   <th style=\"text-align:right;\"> to </th>\n   <th style=\"text-align:right;\"> n </th>\n   <th style=\"text-align:left;\"> transition </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 711 </td>\n   <td style=\"text-align:left;\"> 1 -&gt; 2 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:right;\"> 215 </td>\n   <td style=\"text-align:left;\"> 1 -&gt; 3 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:right;\"> 595 </td>\n   <td style=\"text-align:left;\"> 2 -&gt; 3 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n\n```{.r .cell-code}\n# Final state distribution\nfinal_states <- dat %>%\n  group_by(id) %>%\n  slice_tail(n = 1) %>%\n  ungroup() %>%\n  count(to) %>%\n  mutate(\n    state_name = case_when(\n      to == 1 ~ \"Healthy\",\n      to == 2 ~ \"Illness\", \n      to == 3 ~ \"Death\"\n    ),\n    pct = round(100 * n / sum(n), 1)\n  )\n\nkable(final_states, caption = \"Final State Distribution\") %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"margin-left: auto; margin-right: auto;\">\n<caption>Final State Distribution</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> to </th>\n   <th style=\"text-align:right;\"> n </th>\n   <th style=\"text-align:left;\"> state_name </th>\n   <th style=\"text-align:right;\"> pct </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 74 </td>\n   <td style=\"text-align:left;\"> Healthy </td>\n   <td style=\"text-align:right;\"> 7.4 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 116 </td>\n   <td style=\"text-align:left;\"> Illness </td>\n   <td style=\"text-align:right;\"> 11.6 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:right;\"> 810 </td>\n   <td style=\"text-align:left;\"> Death </td>\n   <td style=\"text-align:right;\"> 81.0 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n## Event Time Distribution\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Plot event time distributions\nevents <- dat %>%\n  filter(status == 1) %>%\n  mutate(transition = factor(paste0(from, \" -> \", to),\n                            levels = c(\"1 -> 2\", \"1 -> 3\", \"2 -> 3\")))\n\nggplot(events, aes(x = tstop)) +\n  geom_histogram(aes(y = after_stat(density)), bins = 30, fill = \"steelblue\", alpha = 0.7) +\n  geom_density(color = \"darkblue\", linewidth = 1) +\n  facet_wrap(~ transition, scales = \"free_y\") +\n  labs(\n    title = \"Distribution of Event Times by Transition\",\n    x = \"Time\",\n    y = \"Density\"\n  )\n```\n\n::: {.cell-output-display}\n![](spline_comparison_benchmark_files/figure-html/event-times-1.png){width=960}\n:::\n:::\n\n\n# Methods\n\n## True Hazard Functions\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Define true hazard functions\ntrue_hazard <- function(t, shape, rate) {\n  shape * rate * t^(shape - 1)\n}\n\ntrue_cumhaz <- function(t, shape, rate) {\n  rate * t^shape\n}\n\n# True hazards\nh12_true <- function(t) true_hazard(t, meta$true_params$h12$shape, meta$true_params$h12$rate)\nh13_true <- function(t) true_hazard(t, meta$true_params$h13$shape, meta$true_params$h13$rate)\nh23_true <- function(t) true_hazard(t, meta$true_params$h23$shape, meta$true_params$h23$rate)\n```\n:::\n\n\n## Standardized Knot Placement\n\nAll three methods use the **same interior knots**: 9 knots placed at the decile quantiles \n(0.1, 0.2, ..., 0.9) of the observed event times from the simulation.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load Julia results early to get standardized knots\njulia_results <- fromJSON(\"../fixtures/illness_death_results.json\")\n\n# Get the standardized interior knots from Julia fit\ninterior_knots <- julia_results$julia_fit$interior_knots\nn_interior_knots <- length(interior_knots)\n\n# Boundary knots (min and max event times)\nevent_times <- dat$tstop[dat$status == 1]\nboundary_knots <- c(min(event_times), max(event_times))\n\ncat(\"Standardized Knot Specification:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nStandardized Knot Specification:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  Number of interior knots:\", n_interior_knots, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Number of interior knots: 9 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  Interior knots (decile quantiles):\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Interior knots (decile quantiles):\n```\n\n\n:::\n\n```{.r .cell-code}\nfor (i in seq_along(interior_knots)) {\n  cat(sprintf(\"    Q%d: %.3f\\n\", i * 10, interior_knots[i]))\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n    Q10: 2.196\n    Q20: 3.972\n    Q30: 5.714\n    Q40: 7.094\n    Q50: 8.695\n    Q60: 10.289\n    Q70: 11.994\n    Q80: 13.923\n    Q90: 16.380\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  Boundary knots:\", round(boundary_knots, 3), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Boundary knots: 0.018 19.979 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  Total spline df:\", n_interior_knots + 2, \"(interior + 2 for natural spline)\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Total spline df: 11 (interior + 2 for natural spline)\n```\n\n\n:::\n:::\n\n\n## Method 1: pammtools/mgcv (PAM)\n\nThe piecewise-exponential additive model (PAM) transforms survival data into a Poisson \nregression framework. Following Bender et al. (2018) and the pammtools documentation:\n\n**Data Transformation:**\n\n1. Split follow-up time into intervals using a set of cut points\n2. For each subject-interval combination, create a pseudo-observation with:\n   - Exposure time (offset): $\\log(\\text{time at risk in interval})$\n   - Event indicator: 1 if event occurred in interval, 0 otherwise\n\n**Model:**\n\n$$\\log(E[d_{ij}]) = \\log(t_{ij}) + f(t_j) + \\mathbf{x}_i'\\boldsymbol{\\beta}$$\n\nwhere $d_{ij}$ is the event indicator for subject $i$ in interval $j$, $t_{ij}$ is the \nexposure time, and $f(t)$ is a smooth function of time.\n\n**Spline specification:** We use a cubic regression spline with the **same knots** as Julia.\nThe `mgcv::gam` function uses penalized splines, but we fix the knot locations to match.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create cut points for PAM\nn_intervals <- 30\nmax_t <- max(dat$tstop)\ncut_points <- seq(0, max_t * 1.01, length.out = n_intervals + 1)\n\n# Function to create PAM data for a specific transition\ncreate_pam_data <- function(dat, from_state, to_state, cuts) {\n  # Filter to subjects at risk from this state\n  trans_dat <- dat[dat$from == from_state, ]\n  \n  pam_rows <- list()\n  \n  for (i in 1:nrow(trans_dat)) {\n    row <- trans_dat[i, ]\n    t_start <- row$tstart\n    t_end <- row$tstop\n    is_event <- (row$status == 1) && (row$to == to_state)\n    \n    for (j in 1:(length(cuts)-1)) {\n      int_start <- cuts[j]\n      int_end <- cuts[j+1]\n      \n      if (int_end <= t_start) next\n      if (int_start >= t_end) break\n      \n      risk_start <- max(int_start, t_start)\n      risk_end <- min(int_end, t_end)\n      offset_val <- log(risk_end - risk_start)\n      \n      event_in_interval <- is_event && (t_end <= int_end) && (t_end > int_start)\n      \n      pam_rows[[length(pam_rows) + 1]] <- data.frame(\n        id = row$id,\n        interval = j,\n        t_mid = (risk_start + risk_end) / 2,\n        t_start = risk_start,\n        t_end = risk_end,\n        offset = offset_val,\n        event = as.integer(event_in_interval)\n      )\n    }\n  }\n  \n  do.call(rbind, pam_rows)\n}\n\n# Create PAM datasets\npam_12 <- create_pam_data(dat, 1, 2, cut_points)\npam_13 <- create_pam_data(dat, 1, 3, cut_points)\npam_23 <- create_pam_data(dat, 2, 3, cut_points)\n\ncat(\"PAM Data Created:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPAM Data Created:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  Transition 1->2:\", nrow(pam_12), \"rows,\", sum(pam_12$event), \"events\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Transition 1->2: 13011 rows, 711 events\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  Transition 1->3:\", nrow(pam_13), \"rows,\", sum(pam_13$event), \"events\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Transition 1->3: 13011 rows, 215 events\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  Transition 2->3:\", nrow(pam_23), \"rows,\", sum(pam_23$event), \"events\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Transition 2->3: 6004 rows, 595 events\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Fit GAM models using cubic regression splines with FIXED knot locations\n# to match Julia's specification exactly\nt_start_pam <- Sys.time()\n\n# For mgcv with bs=\"cr\" (cubic regression spline):\n# When supplying knots, k = number of knots supplied\n# The knots argument specifies ALL knots (not just interior)\nk_mgcv <- n_interior_knots\n\nfit_pam_12 <- gam(event ~ s(t_mid, bs = \"cr\", k = k_mgcv), \n                   family = poisson(), \n                   offset = offset,\n                   data = pam_12,\n                   knots = list(t_mid = interior_knots),\n                   method = \"REML\")\n\nfit_pam_13 <- gam(event ~ s(t_mid, bs = \"cr\", k = k_mgcv), \n                   family = poisson(), \n                   offset = offset,\n                   data = pam_13,\n                   knots = list(t_mid = interior_knots),\n                   method = \"REML\")\n\nfit_pam_23 <- gam(event ~ s(t_mid, bs = \"cr\", k = k_mgcv), \n                   family = poisson(), \n                   offset = offset,\n                   data = pam_23,\n                   knots = list(t_mid = interior_knots),\n                   method = \"REML\")\n\nt_pam <- as.numeric(Sys.time() - t_start_pam, units = \"secs\")\n\ncat(\"PAM Fit Time:\", round(t_pam, 2), \"seconds\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPAM Fit Time: 0.42 seconds\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"\\nEffective Degrees of Freedom (after penalization):\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nEffective Degrees of Freedom (after penalization):\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  h12:\", round(sum(fit_pam_12$edf), 2), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  h12: 3.1 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  h13:\", round(sum(fit_pam_13$edf), 2), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  h13: 2 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  h23:\", round(sum(fit_pam_23$edf), 2), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  h23: 3.8 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"\\nKnots used by mgcv:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nKnots used by mgcv:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  Interior knots:\", round(interior_knots, 3), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Interior knots: 2.196 3.972 5.714 7.094 8.695 10.289 11.994 13.923 16.38 \n```\n\n\n:::\n:::\n\n\n## Method 2: flexsurv\n\nThe flexsurv package implements flexible parametric survival models using cubic splines \non the log cumulative hazard or log hazard scale (Royston-Parmar models).\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Prepare data for flexsurv (one row per transition)\n# For multistate models, we need to create separate datasets\n\n# Transition 1->2: at risk while in state 1, event if goes to state 2\nflex_12 <- dat %>%\n  filter(from == 1) %>%\n  mutate(\n    time = tstop - tstart,\n    status = as.integer(status == 1 & to == 2)\n  ) %>%\n  select(id, time, status)\n\n# Transition 1->3: at risk while in state 1, event if goes to state 3  \nflex_13 <- dat %>%\n  filter(from == 1) %>%\n  mutate(\n    time = tstop - tstart,\n    status = as.integer(status == 1 & to == 3)\n  ) %>%\n  select(id, time, status)\n\n# Transition 2->3: at risk while in state 2, event if goes to state 3\nflex_23 <- dat %>%\n  filter(from == 2) %>%\n  mutate(\n    time = tstop - tstart,\n    status = as.integer(status == 1 & to == 3)\n  ) %>%\n  select(id, time, status)\n\ncat(\"flexsurv Data:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nflexsurv Data:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  Transition 1->2:\", nrow(flex_12), \"observations,\", sum(flex_12$status), \"events\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Transition 1->2: 1000 observations, 711 events\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  Transition 1->3:\", nrow(flex_13), \"observations,\", sum(flex_13$status), \"events\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Transition 1->3: 1000 observations, 215 events\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  Transition 2->3:\", nrow(flex_23), \"observations,\", sum(flex_23$status), \"events\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Transition 2->3: 711 observations, 595 events\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Fit flexible parametric models with splines on log cumulative hazard\n# Using FIXED knot locations to match Julia's specification\n\n# flexsurv places knots on the LOG time scale\n# It automatically adds boundary knots at min and max event times\n# We need to specify internal knots on log scale\nlog_interior_knots <- log(interior_knots)\n\nt_start_flex <- Sys.time()\n\nfit_flex_12 <- flexsurvspline(Surv(time, status) ~ 1, \n                               data = flex_12, \n                               knots = log_interior_knots,\n                               scale = \"hazard\")\n\nfit_flex_13 <- flexsurvspline(Surv(time, status) ~ 1, \n                               data = flex_13, \n                               knots = log_interior_knots,\n                               scale = \"hazard\")\n\nfit_flex_23 <- flexsurvspline(Surv(time, status) ~ 1, \n                               data = flex_23, \n                               knots = log_interior_knots,\n                               scale = \"hazard\")\n\nt_flex <- as.numeric(Sys.time() - t_start_flex, units = \"secs\")\n\ncat(\"flexsurv Fit Time:\", round(t_flex, 2), \"seconds\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nflexsurv Fit Time: 0.71 seconds\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"\\nInterior knots (original scale):\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nInterior knots (original scale):\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  \", round(interior_knots, 3), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   2.196 3.972 5.714 7.094 8.695 10.289 11.994 13.923 16.38 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"\\nInterior knots (log scale for flexsurv):\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nInterior knots (log scale for flexsurv):\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  \", round(log_interior_knots, 3), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   0.787 1.379 1.743 1.959 2.163 2.331 2.484 2.634 2.796 \n```\n\n\n:::\n:::\n\n\n## Method 3: MultistateModels.jl (Julia)\n\nMultistateModels.jl fits all transition hazards jointly via maximum likelihood with \nnatural cubic spline baseline hazards. Results are loaded from pre-computed fits.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load Julia predictions (julia_results already loaded in knot-setup chunk)\njulia_pred <- fromJSON(\"../fixtures/illness_death_julia_predictions.json\")\n\ncat(\"Julia Fit Time:\", round(julia_results$julia_fit$fit_time_seconds, 2), \"seconds\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nJulia Fit Time: 13.22 seconds\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Interior Knots:\", paste(round(julia_results$julia_fit$interior_knots, 2), collapse = \", \"), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nInterior Knots: 2.2, 3.97, 5.71, 7.09, 8.69, 10.29, 11.99, 13.92, 16.38 \n```\n\n\n:::\n:::\n\n\n# Hazard Estimation\n\n## Predicted Hazards\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Evaluation times\neval_times <- seq(0.5, 20, by = 0.5)\n\n# True hazards\nh12_true_vec <- sapply(eval_times, h12_true)\nh13_true_vec <- sapply(eval_times, h13_true)\nh23_true_vec <- sapply(eval_times, h23_true)\n\n# PAM predictions\npred_data <- data.frame(t_mid = eval_times, offset = 0)\nh12_pam <- exp(predict(fit_pam_12, newdata = pred_data, type = \"link\"))\nh13_pam <- exp(predict(fit_pam_13, newdata = pred_data, type = \"link\"))\nh23_pam <- exp(predict(fit_pam_23, newdata = pred_data, type = \"link\"))\n\n# flexsurv predictions\nh12_flex <- summary(fit_flex_12, t = eval_times, type = \"hazard\")[[1]]$est\nh13_flex <- summary(fit_flex_13, t = eval_times, type = \"hazard\")[[1]]$est\nh23_flex <- summary(fit_flex_23, t = eval_times, type = \"hazard\")[[1]]$est\n\n# Julia predictions (from loaded file)\nh12_julia <- julia_pred$hazards$h12_julia\nh13_julia <- julia_pred$hazards$h13_julia\nh23_julia <- julia_pred$hazards$h23_julia\n\n# Combine into data frame\nhazard_df <- data.frame(\n  time = rep(eval_times, 12),\n  hazard = c(h12_true_vec, h12_julia, h12_pam, h12_flex,\n             h13_true_vec, h13_julia, h13_pam, h13_flex,\n             h23_true_vec, h23_julia, h23_pam, h23_flex),\n  method = rep(rep(c(\"True\", \"Julia\", \"PAM (mgcv)\", \"flexsurv\"), each = length(eval_times)), 3),\n  transition = rep(c(\"h12 (Healthy -> Illness)\", \n                     \"h13 (Healthy -> Death)\",\n                     \"h23 (Illness -> Death)\"), each = 4 * length(eval_times))\n)\n```\n:::\n\n\n## Hazard Plots\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(hazard_df, aes(x = time, y = hazard, color = method, linetype = method)) +\n  geom_line(linewidth = 1) +\n  scale_color_manual(values = c(\"True\" = \"black\", \"Julia\" = \"#E69F00\", \n                                 \"PAM (mgcv)\" = \"#56B4E9\", \"flexsurv\" = \"#009E73\")) +\n  scale_linetype_manual(values = c(\"True\" = \"solid\", \"Julia\" = \"dashed\", \n                                    \"PAM (mgcv)\" = \"dotted\", \"flexsurv\" = \"twodash\")) +\n  facet_wrap(~ transition, scales = \"free_y\", ncol = 1) +\n  labs(\n    title = \"Estimated vs True Hazard Functions\",\n    x = \"Time\",\n    y = \"Hazard Rate h(t)\",\n    color = \"Method\",\n    linetype = \"Method\"\n  ) +\n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](spline_comparison_benchmark_files/figure-html/hazard-plots-1.png){width=960}\n:::\n:::\n\n\n## Hazard RMSE\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrmse <- function(a, b) sqrt(mean((a - b)^2))\n\nhazard_rmse <- data.frame(\n  Transition = c(\"h12\", \"h13\", \"h23\"),\n  Julia = c(rmse(h12_julia, h12_true_vec),\n            rmse(h13_julia, h13_true_vec),\n            rmse(h23_julia, h23_true_vec)),\n  PAM_mgcv = c(rmse(h12_pam, h12_true_vec),\n                   rmse(h13_pam, h13_true_vec),\n                   rmse(h23_pam, h23_true_vec)),\n  flexsurv = c(rmse(h12_flex, h12_true_vec),\n               rmse(h13_flex, h13_true_vec),\n               rmse(h23_flex, h23_true_vec))\n)\n\nkable(hazard_rmse, digits = 5, \n      caption = \"Hazard RMSE (vs True)\") %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"margin-left: auto; margin-right: auto;\">\n<caption>Hazard RMSE (vs True)</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Transition </th>\n   <th style=\"text-align:right;\"> Julia </th>\n   <th style=\"text-align:right;\"> PAM_mgcv </th>\n   <th style=\"text-align:right;\"> flexsurv </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> h12 </td>\n   <td style=\"text-align:right;\"> 0.01358 </td>\n   <td style=\"text-align:right;\"> 0.00645 </td>\n   <td style=\"text-align:right;\"> 0.00998 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> h13 </td>\n   <td style=\"text-align:right;\"> 0.00429 </td>\n   <td style=\"text-align:right;\"> 0.00163 </td>\n   <td style=\"text-align:right;\"> 0.00491 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> h23 </td>\n   <td style=\"text-align:right;\"> 0.13832 </td>\n   <td style=\"text-align:right;\"> 0.11949 </td>\n   <td style=\"text-align:right;\"> 0.22306 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n# State Prevalence\n\n## Computing Transition Probabilities\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Compute transition probability matrix via product integral\ncompute_tpm <- function(t, h12_fn, h13_fn, h23_fn, dt = 0.01) {\n  if (t <= 0) return(diag(3))\n  \n  n_steps <- max(1, ceiling(t / dt))\n  actual_dt <- t / n_steps\n  \n  P <- diag(3)\n  \n  for (i in 1:n_steps) {\n    s <- (i - 0.5) * actual_dt\n    \n    h12 <- h12_fn(s)\n    h13 <- h13_fn(s)\n    h23 <- h23_fn(s)\n    \n    Q <- matrix(c(-(h12 + h13), h12, h13,\n                  0, -h23, h23,\n                  0, 0, 0), nrow = 3, byrow = TRUE)\n    \n    dP <- expm(Q * actual_dt)\n    P <- P %*% dP\n  }\n  \n  return(P)\n}\n\n# Create interpolation functions for each method\nmake_interp <- function(times, values) {\n  approxfun(times, values, rule = 2)\n}\n\nh12_pam_fn <- make_interp(eval_times, h12_pam)\nh13_pam_fn <- make_interp(eval_times, h13_pam)\nh23_pam_fn <- make_interp(eval_times, h23_pam)\n\nh12_flex_fn <- make_interp(eval_times, h12_flex)\nh13_flex_fn <- make_interp(eval_times, h13_flex)\nh23_flex_fn <- make_interp(eval_times, h23_flex)\n\nh12_julia_fn <- make_interp(eval_times, h12_julia)\nh13_julia_fn <- make_interp(eval_times, h13_julia)\nh23_julia_fn <- make_interp(eval_times, h23_julia)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Compute state prevalence for each method\nprev_true <- matrix(0, nrow = length(eval_times), ncol = 3)\nprev_julia <- matrix(0, nrow = length(eval_times), ncol = 3)\nprev_pam <- matrix(0, nrow = length(eval_times), ncol = 3)\nprev_flex <- matrix(0, nrow = length(eval_times), ncol = 3)\n\nfor (i in seq_along(eval_times)) {\n  t <- eval_times[i]\n  \n  P_true <- compute_tpm(t, h12_true, h13_true, h23_true)\n  prev_true[i, ] <- P_true[1, ]\n  \n  P_julia <- compute_tpm(t, h12_julia_fn, h13_julia_fn, h23_julia_fn)\n  prev_julia[i, ] <- P_julia[1, ]\n  \n  P_pam <- compute_tpm(t, h12_pam_fn, h13_pam_fn, h23_pam_fn)\n  prev_pam[i, ] <- P_pam[1, ]\n  \n  P_flex <- compute_tpm(t, h12_flex_fn, h13_flex_fn, h23_flex_fn)\n  prev_flex[i, ] <- P_flex[1, ]\n}\n\n# Empirical prevalence from data\nprev_emp <- julia_results$empirical\n```\n:::\n\n\n## Prevalence Plots\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprev_df <- data.frame(\n  time = rep(eval_times, 15),\n  prevalence = c(\n    prev_true[,1], prev_julia[,1], prev_pam[,1], prev_flex[,1], prev_emp$prevalence_healthy,\n    prev_true[,2], prev_julia[,2], prev_pam[,2], prev_flex[,2], prev_emp$prevalence_illness,\n    prev_true[,3], prev_julia[,3], prev_pam[,3], prev_flex[,3], prev_emp$prevalence_death\n  ),\n  method = rep(rep(c(\"True\", \"Julia\", \"PAM (mgcv)\", \"flexsurv\", \"Empirical\"), \n                   each = length(eval_times)), 3),\n  state = rep(c(\"P1(t): Healthy\", \"P2(t): Illness\", \"P3(t): Death\"), \n              each = 5 * length(eval_times))\n)\n\nggplot(prev_df, aes(x = time, y = prevalence, color = method, linetype = method)) +\n  geom_line(linewidth = 1) +\n  scale_color_manual(values = c(\"True\" = \"black\", \"Julia\" = \"#E69F00\", \n                                 \"PAM (mgcv)\" = \"#56B4E9\", \"flexsurv\" = \"#009E73\",\n                                 \"Empirical\" = \"grey50\")) +\n  scale_linetype_manual(values = c(\"True\" = \"solid\", \"Julia\" = \"dashed\", \n                                    \"PAM (mgcv)\" = \"dotted\", \"flexsurv\" = \"twodash\",\n                                    \"Empirical\" = \"dotdash\")) +\n  facet_wrap(~ state, scales = \"free_y\", ncol = 1) +\n  labs(\n    title = \"State Prevalence: Estimated vs True\",\n    subtitle = \"Starting from State 1 (Healthy)\",\n    x = \"Time\",\n    y = \"Probability\",\n    color = \"Method\",\n    linetype = \"Method\"\n  ) +\n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](spline_comparison_benchmark_files/figure-html/prevalence-plots-1.png){width=960}\n:::\n:::\n\n\n## Prevalence RMSE\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprev_rmse <- data.frame(\n  State = c(\"P1 (Healthy)\", \"P2 (Illness)\", \"P3 (Death)\"),\n  Empirical = c(rmse(prev_true[,1], prev_emp$prevalence_healthy),\n                rmse(prev_true[,2], prev_emp$prevalence_illness),\n                rmse(prev_true[,3], prev_emp$prevalence_death)),\n  Julia = c(rmse(prev_true[,1], prev_julia[,1]),\n            rmse(prev_true[,2], prev_julia[,2]),\n            rmse(prev_true[,3], prev_julia[,3])),\n  PAM_mgcv = c(rmse(prev_true[,1], prev_pam[,1]),\n                   rmse(prev_true[,2], prev_pam[,2]),\n                   rmse(prev_true[,3], prev_pam[,3])),\n  flexsurv = c(rmse(prev_true[,1], prev_flex[,1]),\n               rmse(prev_true[,2], prev_flex[,2]),\n               rmse(prev_true[,3], prev_flex[,3]))\n)\n\nkable(prev_rmse, digits = 5,\n      caption = \"State Prevalence RMSE (vs True)\") %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"margin-left: auto; margin-right: auto;\">\n<caption>State Prevalence RMSE (vs True)</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> State </th>\n   <th style=\"text-align:right;\"> Empirical </th>\n   <th style=\"text-align:right;\"> Julia </th>\n   <th style=\"text-align:right;\"> PAM_mgcv </th>\n   <th style=\"text-align:right;\"> flexsurv </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> P1 (Healthy) </td>\n   <td style=\"text-align:right;\"> 0.00839 </td>\n   <td style=\"text-align:right;\"> 0.00790 </td>\n   <td style=\"text-align:right;\"> 0.01080 </td>\n   <td style=\"text-align:right;\"> 0.00803 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> P2 (Illness) </td>\n   <td style=\"text-align:right;\"> 0.06081 </td>\n   <td style=\"text-align:right;\"> 0.01633 </td>\n   <td style=\"text-align:right;\"> 0.05858 </td>\n   <td style=\"text-align:right;\"> 0.01752 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> P3 (Death) </td>\n   <td style=\"text-align:right;\"> 0.05591 </td>\n   <td style=\"text-align:right;\"> 0.02269 </td>\n   <td style=\"text-align:right;\"> 0.05474 </td>\n   <td style=\"text-align:right;\"> 0.02337 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n# Cumulative Incidence\n\n## Computing Cumulative Incidence\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Compute cause-specific cumulative incidence\n# CI_1r(t) = integral_0^t P11(s) * h1r(s) ds\ncompute_ci <- function(times, h_fn, h12_all_fn, h13_all_fn, h23_all_fn, dt = 0.05) {\n  ci <- numeric(length(times))\n  \n  for (i in seq_along(times)) {\n    t <- times[i]\n    if (t <= 0) {\n      ci[i] <- 0\n      next\n    }\n    \n    n_steps <- max(1, ceiling(t / dt))\n    actual_dt <- t / n_steps\n    \n    integral <- 0\n    for (j in 1:n_steps) {\n      s <- (j - 0.5) * actual_dt\n      P <- compute_tpm(s, h12_all_fn, h13_all_fn, h23_all_fn, dt = 0.05)\n      P11 <- P[1, 1]\n      h <- h_fn(s)\n      integral <- integral + P11 * h * actual_dt\n    }\n    ci[i] <- integral\n  }\n  \n  return(ci)\n}\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# True cumulative incidence\nci_12_true <- compute_ci(eval_times, h12_true, h12_true, h13_true, h23_true)\nci_13_true <- compute_ci(eval_times, h13_true, h12_true, h13_true, h23_true)\n\n# Julia CI\nci_12_julia <- compute_ci(eval_times, h12_julia_fn, h12_julia_fn, h13_julia_fn, h23_julia_fn)\nci_13_julia <- compute_ci(eval_times, h13_julia_fn, h12_julia_fn, h13_julia_fn, h23_julia_fn)\n\n# PAM CI\nci_12_pam <- compute_ci(eval_times, h12_pam_fn, h12_pam_fn, h13_pam_fn, h23_pam_fn)\nci_13_pam <- compute_ci(eval_times, h13_pam_fn, h12_pam_fn, h13_pam_fn, h23_pam_fn)\n\n# flexsurv CI\nci_12_flex <- compute_ci(eval_times, h12_flex_fn, h12_flex_fn, h13_flex_fn, h23_flex_fn)\nci_13_flex <- compute_ci(eval_times, h13_flex_fn, h12_flex_fn, h13_flex_fn, h23_flex_fn)\n\n# Total death CI = P(state 3)\nci_death_true <- prev_true[, 3]\nci_death_julia <- prev_julia[, 3]\nci_death_pam <- prev_pam[, 3]\nci_death_flex <- prev_flex[, 3]\n```\n:::\n\n\n## Cumulative Incidence Plots\n\n\n::: {.cell}\n\n```{.r .cell-code}\nci_df <- data.frame(\n  time = rep(eval_times, 12),\n  ci = c(\n    ci_12_true, ci_12_julia, ci_12_pam, ci_12_flex,\n    ci_13_true, ci_13_julia, ci_13_pam, ci_13_flex,\n    ci_death_true, ci_death_julia, ci_death_pam, ci_death_flex\n  ),\n  method = rep(rep(c(\"True\", \"Julia\", \"PAM (mgcv)\", \"flexsurv\"), each = length(eval_times)), 3),\n  event = rep(c(\"CI12: Illness\", \"CI13: Direct Death\", \"CI Total Death\"), \n              each = 4 * length(eval_times))\n)\n\nggplot(ci_df, aes(x = time, y = ci, color = method, linetype = method)) +\n  geom_line(linewidth = 1) +\n  scale_color_manual(values = c(\"True\" = \"black\", \"Julia\" = \"#E69F00\", \n                                 \"PAM (mgcv)\" = \"#56B4E9\", \"flexsurv\" = \"#009E73\")) +\n  scale_linetype_manual(values = c(\"True\" = \"solid\", \"Julia\" = \"dashed\", \n                                    \"PAM (mgcv)\" = \"dotted\", \"flexsurv\" = \"twodash\")) +\n  facet_wrap(~ event, scales = \"free_y\", ncol = 1) +\n  labs(\n    title = \"Cumulative Incidence Functions\",\n    subtitle = \"Starting from State 1 (Healthy)\",\n    x = \"Time\",\n    y = \"Cumulative Incidence\",\n    color = \"Method\",\n    linetype = \"Method\"\n  ) +\n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](spline_comparison_benchmark_files/figure-html/ci-plots-1.png){width=960}\n:::\n:::\n\n\n## Cumulative Incidence RMSE\n\n\n::: {.cell}\n\n```{.r .cell-code}\nci_rmse <- data.frame(\n  Cumulative_Incidence = c(\"CI12 (Illness)\", \"CI13 (Direct Death)\", \"CI Total Death\"),\n  Julia = c(rmse(ci_12_true, ci_12_julia),\n            rmse(ci_13_true, ci_13_julia),\n            rmse(ci_death_true, ci_death_julia)),\n  PAM_mgcv = c(rmse(ci_12_true, ci_12_pam),\n                   rmse(ci_13_true, ci_13_pam),\n                   rmse(ci_death_true, ci_death_pam)),\n  flexsurv = c(rmse(ci_12_true, ci_12_flex),\n               rmse(ci_13_true, ci_13_flex),\n               rmse(ci_death_true, ci_death_flex))\n)\n\nkable(ci_rmse, digits = 5,\n      caption = \"Cumulative Incidence RMSE (vs True)\") %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"margin-left: auto; margin-right: auto;\">\n<caption>Cumulative Incidence RMSE (vs True)</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Cumulative_Incidence </th>\n   <th style=\"text-align:right;\"> Julia </th>\n   <th style=\"text-align:right;\"> PAM_mgcv </th>\n   <th style=\"text-align:right;\"> flexsurv </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> CI12 (Illness) </td>\n   <td style=\"text-align:right;\"> 0.00762 </td>\n   <td style=\"text-align:right;\"> 0.00720 </td>\n   <td style=\"text-align:right;\"> 0.00793 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> CI13 (Direct Death) </td>\n   <td style=\"text-align:right;\"> 0.00911 </td>\n   <td style=\"text-align:right;\"> 0.00791 </td>\n   <td style=\"text-align:right;\"> 0.00948 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> CI Total Death </td>\n   <td style=\"text-align:right;\"> 0.02269 </td>\n   <td style=\"text-align:right;\"> 0.05474 </td>\n   <td style=\"text-align:right;\"> 0.02337 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n# Summary\n\n## Overall Comparison\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create summary\nsummary_df <- data.frame(\n  Category = c(\"Hazard h12\", \"Hazard h13\", \"Hazard h23\",\n               \"Prevalence P1\", \"Prevalence P2\", \"Prevalence P3\",\n               \"CI Illness\", \"CI Direct Death\", \"CI Total Death\"),\n  Julia = c(hazard_rmse$Julia, prev_rmse$Julia, ci_rmse$Julia),\n  PAM_mgcv = c(hazard_rmse$PAM_mgcv, prev_rmse$PAM_mgcv, ci_rmse$PAM_mgcv),\n  flexsurv = c(hazard_rmse$flexsurv, prev_rmse$flexsurv, ci_rmse$flexsurv)\n)\n\n# Add winner column\nsummary_df$Winner <- apply(summary_df[, 2:4], 1, function(x) {\n  methods <- c(\"Julia\", \"PAM (mgcv)\", \"flexsurv\")\n  methods[which.min(x)]\n})\n\nkable(summary_df, digits = 5,\n      caption = \"Summary: RMSE by Method and Metric\") %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\")) %>%\n  column_spec(5, bold = TRUE)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"margin-left: auto; margin-right: auto;\">\n<caption>Summary: RMSE by Method and Metric</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Category </th>\n   <th style=\"text-align:right;\"> Julia </th>\n   <th style=\"text-align:right;\"> PAM_mgcv </th>\n   <th style=\"text-align:right;\"> flexsurv </th>\n   <th style=\"text-align:left;\"> Winner </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Hazard h12 </td>\n   <td style=\"text-align:right;\"> 0.01358 </td>\n   <td style=\"text-align:right;\"> 0.00645 </td>\n   <td style=\"text-align:right;\"> 0.00998 </td>\n   <td style=\"text-align:left;font-weight: bold;\"> PAM (mgcv) </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Hazard h13 </td>\n   <td style=\"text-align:right;\"> 0.00429 </td>\n   <td style=\"text-align:right;\"> 0.00163 </td>\n   <td style=\"text-align:right;\"> 0.00491 </td>\n   <td style=\"text-align:left;font-weight: bold;\"> PAM (mgcv) </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Hazard h23 </td>\n   <td style=\"text-align:right;\"> 0.13832 </td>\n   <td style=\"text-align:right;\"> 0.11949 </td>\n   <td style=\"text-align:right;\"> 0.22306 </td>\n   <td style=\"text-align:left;font-weight: bold;\"> PAM (mgcv) </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Prevalence P1 </td>\n   <td style=\"text-align:right;\"> 0.00790 </td>\n   <td style=\"text-align:right;\"> 0.01080 </td>\n   <td style=\"text-align:right;\"> 0.00803 </td>\n   <td style=\"text-align:left;font-weight: bold;\"> Julia </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Prevalence P2 </td>\n   <td style=\"text-align:right;\"> 0.01633 </td>\n   <td style=\"text-align:right;\"> 0.05858 </td>\n   <td style=\"text-align:right;\"> 0.01752 </td>\n   <td style=\"text-align:left;font-weight: bold;\"> Julia </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Prevalence P3 </td>\n   <td style=\"text-align:right;\"> 0.02269 </td>\n   <td style=\"text-align:right;\"> 0.05474 </td>\n   <td style=\"text-align:right;\"> 0.02337 </td>\n   <td style=\"text-align:left;font-weight: bold;\"> Julia </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> CI Illness </td>\n   <td style=\"text-align:right;\"> 0.00762 </td>\n   <td style=\"text-align:right;\"> 0.00720 </td>\n   <td style=\"text-align:right;\"> 0.00793 </td>\n   <td style=\"text-align:left;font-weight: bold;\"> PAM (mgcv) </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> CI Direct Death </td>\n   <td style=\"text-align:right;\"> 0.00911 </td>\n   <td style=\"text-align:right;\"> 0.00791 </td>\n   <td style=\"text-align:right;\"> 0.00948 </td>\n   <td style=\"text-align:left;font-weight: bold;\"> PAM (mgcv) </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> CI Total Death </td>\n   <td style=\"text-align:right;\"> 0.02269 </td>\n   <td style=\"text-align:right;\"> 0.05474 </td>\n   <td style=\"text-align:right;\"> 0.02337 </td>\n   <td style=\"text-align:left;font-weight: bold;\"> Julia </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n## Computation Time\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntiming_df <- data.frame(\n  Method = c(\"MultistateModels.jl (Julia)\", \"PAM (mgcv)\", \"flexsurv\"),\n  Fit_Time_s = c(julia_results$julia_fit$fit_time_seconds, t_pam, t_flex),\n  Approach = c(\"Joint likelihood (all transitions)\", \n               \"Separate GAMs (independent)\", \n               \"Separate MLE (independent)\")\n)\n\nkable(timing_df, digits = 2,\n      caption = \"Computation Time Comparison\") %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"margin-left: auto; margin-right: auto;\">\n<caption>Computation Time Comparison</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Method </th>\n   <th style=\"text-align:right;\"> Fit_Time_s </th>\n   <th style=\"text-align:left;\"> Approach </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> MultistateModels.jl (Julia) </td>\n   <td style=\"text-align:right;\"> 13.22 </td>\n   <td style=\"text-align:left;\"> Joint likelihood (all transitions) </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> PAM (mgcv) </td>\n   <td style=\"text-align:right;\"> 0.42 </td>\n   <td style=\"text-align:left;\"> Separate GAMs (independent) </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> flexsurv </td>\n   <td style=\"text-align:right;\"> 0.71 </td>\n   <td style=\"text-align:left;\"> Separate MLE (independent) </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n## Conclusions\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Count wins\nwins <- table(summary_df$Winner)\ncat(\"Method Wins (out of 9 metrics):\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nMethod Wins (out of 9 metrics):\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(wins)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n     Julia PAM (mgcv) \n         4          5 \n```\n\n\n:::\n:::\n\n\n### Key Findings\n\n1. **MultistateModels.jl** uses joint likelihood estimation, fitting all transition hazards \n   simultaneously. This captures the multistate structure correctly.\n\n2. **pammtools/mgcv** fits each transition independently using GAMs with NCV smoothing \n   parameter selection. While computationally efficient, it ignores cross-transition \n   dependencies.\n\n3. **flexsurv** provides flexible parametric models with excellent hazard estimation but \n   also fits transitions independently.\n\n4. For **state prevalence** and **cumulative incidence** estimation, joint modeling \n   (Julia) tends to outperform independent fitting approaches because it correctly \n   accounts for competing risks.\n\n### Recommendations\n\n- For exploratory analysis of individual hazard shapes: Any method works well\n- For accurate prevalence/cumulative incidence prediction: Joint likelihood (Julia) preferred\n- For large datasets with complex covariate structures: Consider pammtools for flexibility\n\n# Session Info\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nR version 4.5.1 (2025-06-13)\nPlatform: aarch64-apple-darwin20\nRunning under: macOS Sequoia 15.7.3\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRblas.0.dylib \nLAPACK: /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.1\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: America/New_York\ntzcode source: internal\n\nattached base packages:\n[1] splines   stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n [1] kableExtra_1.4.0 knitr_1.50       patchwork_1.3.2  jsonlite_2.0.0  \n [5] expm_1.0-0       Matrix_1.7-3     mstate_0.3.3     flexsurv_2.3.2  \n [9] survival_3.8-3   pammtools_0.7.3  mgcv_1.9-3       nlme_3.1-168    \n[13] lubridate_1.9.4  forcats_1.0.0    stringr_1.5.1    dplyr_1.1.4     \n[17] purrr_1.1.0      readr_2.1.5      tidyr_1.3.1      tibble_3.3.0    \n[21] ggplot2_3.5.2    tidyverse_2.0.0 \n\nloaded via a namespace (and not attached):\n [1] tidyselect_1.2.1    viridisLite_0.4.2   farver_2.1.2       \n [4] fastmap_1.2.0       lazyeval_0.2.2      digest_0.6.37      \n [7] timechange_0.3.0    lifecycle_1.0.4     statmod_1.5.1      \n[10] magrittr_2.0.3      compiler_4.5.1      rlang_1.1.6        \n[13] tools_4.5.1         yaml_2.3.10         data.table_1.17.8  \n[16] labeling_0.4.3      timereg_2.0.7       htmlwidgets_1.6.4  \n[19] xml2_1.4.0          RColorBrewer_1.1-3  withr_3.0.2        \n[22] numDeriv_2016.8-1.1 pec_2025.06.24      grid_4.5.1         \n[25] future_1.67.0       globals_0.18.0      scales_1.4.0       \n[28] iterators_1.0.14    cli_3.6.5           mvtnorm_1.3-3      \n[31] rmarkdown_2.29      generics_0.1.4      rstudioapi_0.17.1  \n[34] future.apply_1.20.0 tzdb_0.5.0          parallel_4.5.1     \n[37] scam_1.2-20         muhaz_1.2.6.4       vctrs_0.6.5        \n[40] hms_1.1.3           Formula_1.2-5       listenv_0.9.1      \n[43] systemfonts_1.2.3   foreach_1.5.2       glue_1.8.0         \n[46] parallelly_1.45.1   codetools_0.2-20    stringi_1.8.7      \n[49] gtable_0.3.6        quadprog_1.5-8      pillar_1.11.0      \n[52] htmltools_0.5.8.1   deSolve_1.40        lava_1.8.1         \n[55] R6_2.6.1            textshaping_1.0.1   evaluate_1.0.5     \n[58] lattice_0.22-7      backports_1.5.0     Rcpp_1.1.0         \n[61] svglite_2.2.1       prodlim_2025.04.28  checkmate_2.3.3    \n[64] xfun_0.53           pkgconfig_2.0.3    \n```\n\n\n:::\n:::\n\n",
    "supporting": [
      "spline_comparison_benchmark_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}