---
title: "Long Tests Status"
subtitle: "Statistical recovery of parameters"
date: last-modified
---

```{julia}
#| echo: false
#| output: false
using Pkg
Pkg.activate(joinpath(@__DIR__, ".."))
using DataFrames
using JSON3
using CairoMakie
using Statistics

# Load ReportHelpers
include("../src/ReportHelpers.jl")
using .ReportHelpers

# Get longtest results directory
RESULTS_DIR = normpath(joinpath(@__DIR__, "..", "cache", "longtest_results"))
```

## 1. Test Inventory

```{julia}
#| echo: false
#| label: tbl-inventory
#| tbl-cap: "Long Test Results Summary"

inventory = create_test_inventory_df(RESULTS_DIR)

if nrow(inventory) == 0
    println("No test results found in cache. Run long tests first.")
else
    # Summary stats
    n_pass = count(x -> occursin("Pass", x), inventory.Status)
    n_fail = count(x -> occursin("Fail", x), inventory.Status)
    n_total = nrow(inventory)
    
    println("**Summary**: $n_pass / $n_total tests passed ($n_fail failed)")
    println("")
    
    # Display table
    inventory
end
```

## 2. Parametric Models

### 2.1 Exponential Hazard

```{julia}
#| echo: false
#| label: fig-exp-exact

# Load results for exponential exact tests
exp_tests = ["exp_exact_nocov", "exp_exact_fixed", "exp_exact_tvc"]

for test_name in exp_tests
    result = load_longtest_result(test_name)
    if !isnothing(result)
        println("#### $test_name")
        println("- **Status**: $(get(result, :passed, false) ? "✅ Pass" : "❌ Fail")")
        println("- **N subjects**: $(get(result, :n_subjects, "?"))")
        println("")
        
        # Parameter table
        params = get(result, :true_params, Dict())
        estimates = get(result, :estimated_params, Dict())
        if !isempty(params)
            println("| Parameter | True | Estimated |")
            println("|-----------|------|-----------|")
            for (k, v) in params
                est = get(estimates, k, NaN)
                println("| $k | $(round(v, digits=4)) | $(round(est, digits=4)) |")
            end
            println("")
        end
    else
        println("#### $test_name\n*Not yet run*\n")
    end
end
```

### 2.2 Weibull Hazard

```{julia}
#| echo: false

wei_tests = ["wei_exact_nocov", "wei_exact_fixed", "wei_exact_tvc", 
             "wei_mcem_nocov", "wei_mcem_fixed", "wei_mcem_tvc"]

for test_name in wei_tests
    result = load_longtest_result(test_name)
    if !isnothing(result)
        println("#### $test_name")
        println("- **Status**: $(get(result, :passed, false) ? "✅ Pass" : "❌ Fail")")
        println("- **N subjects**: $(get(result, :n_subjects, "?"))")
        println("")
    else
        println("#### $test_name\n*Not yet run*\n")
    end
end
```

### 2.3 Gompertz Hazard

```{julia}
#| echo: false

gom_tests = ["gom_exact_nocov", "gom_exact_fixed", "gom_exact_tvc",
             "gom_mcem_nocov", "gom_mcem_fixed", "gom_mcem_tvc"]

for test_name in gom_tests
    result = load_longtest_result(test_name)
    if !isnothing(result)
        println("#### $test_name")
        println("- **Status**: $(get(result, :passed, false) ? "✅ Pass" : "❌ Fail")")
        println("- **N subjects**: $(get(result, :n_subjects, "?"))")
        println("")
    else
        println("#### $test_name\n*Not yet run*\n")
    end
end
```

## 3. Panel Data (Exponential / Markov)

```{julia}
#| echo: false

panel_tests = ["exp_panel_nocov", "exp_panel_fixed", "exp_panel_tvc"]

for test_name in panel_tests
    result = load_longtest_result(test_name)
    if !isnothing(result)
        println("#### $test_name")
        println("- **Status**: $(get(result, :passed, false) ? "✅ Pass" : "❌ Fail")")
        println("- **N subjects**: $(get(result, :n_subjects, "?"))")
        println("")
    else
        println("#### $test_name\n*Not yet run*\n")
    end
end
```

## 4. Penalized Spline Models

### 4.1 Smooth Covariate Effects (s(x))

Tests for single-dimensional smooth covariate effects using `s(x)` terms with 
automatic PIJCV smoothing parameter selection.

| Test | True Function | Status |
|------|---------------|--------|
| Sinusoidal | f(x) = sin(2πx) | ✅ Pass |
| Quadratic | f(x) = x² | ✅ Pass |
| Sigmoid | f(x) = tanh(5(x-0.5)) | ✅ Pass |
| s(x) + Linear | f(x) = sin(2πx) + 0.5·trt | ✅ Pass |

**Test Parameters**: n=500 subjects, k=10-12 basis functions, max_time=10

### 4.2 Tensor Product Smooths (te(x,y))

Tests for 2D smooth covariate surfaces using `te(x,y)` terms.

| Test | True Surface | Status |
|------|--------------|--------|
| Separable | g(x,y) = sin(πx)cos(πy) | ✅ Pass |
| Bilinear | g(x,y) = (x-0.5)(y-0.5) | ✅ Pass |
| Additive | g(x,y) = sin(2πx) + 0.5cos(2πy) | ✅ Pass |
| te() vs s()+s() | Comparison for additive surface | ✅ Pass |

**Test Parameters**: n=800 subjects, k=5×5 tensor basis

### 4.3 MCEM with Spline Hazards

Tests for spline baseline hazards in the MCEM algorithm with panel data.

| Test | Approximates | Status |
|------|--------------|--------|
| Linear spline | Exponential (constant) hazard | ✅ Pass |
| Piecewise spline | Step function hazard | ✅ Pass |
| Cubic spline | Gompertz (exponential increase) | ✅ Pass |
| Spline + covariate | Log hazard ratio recovery | ✅ Pass |
| Monotone spline | Constraint enforcement | ✅ Pass |
| PhaseType proposal | Spline with MCEM sampling | ✅ Pass |

**Test Parameters**: n=1000 subjects, MCEM tolerance=0.05

## 5. Notes

- Tests use a 3-state progressive model: State 1 → State 2 → State 3
- Parameter recovery tolerance: 35% relative error for main parameters
- TVC (time-varying covariate) tests verify covariate effects change at t=5
- AFT (accelerated failure time) with TVC uses effective time τ(t) = ∫exp(-βx(s))ds
- Exact data uses `obstype=1` (continuous observation)
- Panel data uses discrete observation times with MCEM for semi-Markov families
